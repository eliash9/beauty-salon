<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Beauty Salon - Booking</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#e11d48">
  <link rel="icon" href="icons/icon-48x48.png" type="image/png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ color-scheme: light;}
    body{ font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    .no-tap-highlight{-webkit-tap-highlight-color: rgba(0,0,0,0);}
    .card{ box-shadow: 0 8px 24px rgba(0,0,0,.06); }
  </style>
</head>
<body class="bg-gradient-to-b from-rose-50 to-pink-100 text-slate-800 no-tap-highlight">
  <header class="sticky top-0 z-30 bg-gradient-to-r from-rose-600 to-pink-600 text-white">
    <div class="max-w-md mx-auto px-4 py-3">
      <div class="flex items-center gap-3">
        <img src="icons/icon-512x512.png" alt="" class="h-7 w-7 rounded-lg" loading="lazy" decoding="async">
        <h1 id="brand" class="font-semibold text-lg tracking-wide">Beauty Salon</h1>
      </div>
    </div>
  </header>

  <main id="app" class="max-w-md mx-auto pb-36 safe-bottom">
    <div class="px-4 mt-4">
      <label class="sr-only" for="q">Cari</label>
      <div class="relative">
        <input id="q" class="w-full rounded-2xl bg-white border border-pink-100 py-3 pl-11 pr-4 outline-none focus:ring-2 focus:ring-pink-300" placeholder="Cari layanan / stylist..." />
        <svg class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-pink-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"/></svg>
      </div>
    </div>

    <section class="px-4 mt-6">
      <h2 class="text-sm font-semibold text-pink-700">Layanan Kami</h2>
      <div id="services" class="mt-3 grid grid-cols-3 gap-3"></div>
    </section>

    <section class="px-4 mt-6">
      <div class="card rounded-2xl bg-gradient-to-r from-pink-100 to-pink-50 p-4 flex items-center gap-4">
        <div class="flex-1">
          <p class="text-sm font-semibold text-pink-700">Kunjungi Portofolio</p>
          <p class="text-xs text-slate-600">Lihat hasil makeover terbaru kami</p>
        </div>
        <a href="portofolio.html" class="rounded-xl bg-pink-600 text-white text-sm font-medium px-4 py-2">Lihat</a>
      </div>
    </section>

    <section class="px-4 mt-6">
      <h2 class="text-sm font-semibold text-pink-700">Tim Kami</h2>
      <div id="team" class="mt-3 flex gap-3 overflow-x-auto snap-x snap-mandatory pb-2"></div>
    </section>

    <section class="px-4 mt-6">
      <div class="card rounded-3xl bg-white">
        <div class="p-4 border-b border-pink-100 flex items-center gap-3">
          <img id="profile-photo" loading="lazy" alt="" class="h-14 w-14 rounded-full object-cover" src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=200&auto=format&fit=crop" />
          <div class="flex-1">
            <div class="flex items-center gap-1 text-pink-600">
              <span class="font-semibold">4.5</span>
              <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.802 2.035a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.802-2.035a1 1 0 00-1.175 0l-2.802 2.035c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81H7.03a1 1 0 00.95-.69l1.07-3.292z"/></svg>
            </div>
            <p id="profile-name" class="font-semibold leading-tight">-</p>
            <p id="profile-role" class="text-xs text-slate-500">-</p>
          </div>
          <button class="p-2 rounded-xl bg-pink-50 text-pink-600" title="Favorit" aria-label="Favorit">
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5A5.49 5.49 0 017.5 3a5.87 5.87 0 014.5 2.09A5.87 5.87 0 0116.5 3 5.49 5.49 0 0122 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
          </button>
        </div>

        <div class="px-4 pt-3">
          <div class="text-sm font-semibold text-pink-700">Daftar Harga</div>
          <div id="priceList" class="mt-2 grid grid-cols-2 gap-3 text-sm"></div>
        </div>

        <div class="px-4 mt-4">
          <div class="text-sm font-semibold text-pink-700">7 Hari Ke Depan</div>
          <div id="week" class="mt-2 grid grid-cols-7 gap-1 text-center"></div>
        </div>

        <div class="px-4 py-4">
          <div class="text-sm font-semibold text-pink-700 mb-2">Pilih Jam</div>
          <div id="slots" class="grid grid-cols-2 gap-2"></div>
          <div id="slotLegend" class="mt-2 flex items-center gap-4 text-xs text-slate-600">
            <span class="inline-flex items-center gap-1"><span class="inline-block h-3 w-3 rounded bg-white border border-pink-200"></span> Tersedia</span>
            <span class="inline-flex items-center gap-1"><span class="inline-block h-3 w-3 rounded bg-amber-50 border border-amber-200"></span> Hold</span>
            <span class="inline-flex items-center gap-1"><span class="inline-block h-3 w-3 rounded bg-slate-100 border border-slate-200"></span> Booked</span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="fixed bottom-16 left-0 right-0 z-40">
    <div class="max-w-md mx-auto px-4 pb-4 pt-3 bg-white/90 backdrop-blur border-t border-pink-100 safe-bottom">
      <div class="flex items-center gap-3">
        <div class="flex-1">
          <p id="summary" class="text-xs text-slate-600">Belum ada pilihan.</p>
        </div>
        <button id="btnBook" class="rounded-2xl bg-pink-600 hover:bg-pink-700 text-white font-semibold text-sm px-5 py-3 disabled:opacity-50" disabled>Booking</button>
      </div>
    </div>
  </div>

  <nav class="fixed bottom-0 left-0 right-0 z-50 bg-white/95 backdrop-blur border-t border-pink-100 safe-bottom">
    <div id="bottomnav" class="max-w-md mx-auto flex items-stretch justify-around py-2 px-2 text-xs"></div>
  </nav>

  <dialog id="dlg" class="rounded-2xl p-0 border-0 w-[92%] max-w-md">
    <div class="card rounded-2xl bg-white">
      <div class="p-4 border-b border-pink-100 flex items-center justify-between">
        <h3 class="font-semibold">Konfirmasi Booking</h3>
        <button id="dlgClose" class="p-2 rounded-xl text-slate-500 hover:bg-slate-100" aria-label="Tutup">
          <svg class="h-5 w-5" viewBox="0 0 24 24" stroke="currentColor" fill="none"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="p-4 text-sm">
        <label for="custName" class="text-xs text-slate-500">Nama Pemesan</label>
        <input id="custName" class="mt-1 mb-3 w-full rounded-xl border border-pink-200 px-3 py-2 outline-none focus:ring-2 focus:ring-pink-300" placeholder="Masukkan nama Anda" />
        <p class="mb-1"><span class="text-slate-500">Dilayani oleh:</span> <span id="cName" class="font-medium"></span></p>
        <p class="mb-1"><span class="text-slate-500">Layanan:</span> <span id="cService" class="font-medium"></span></p>
        <p class="mb-1"><span class="text-slate-500">Tanggal:</span> <span id="cDate" class="font-medium"></span></p>
        <p class="mb-1"><span class="text-slate-500">Jam:</span> <span id="cTime" class="font-medium"></span></p>
      </div>
      <div class="p-4 pt-0">
        <button id="dlgConfirm" class="w-full rounded-2xl bg-pink-600 hover:bg-pink-700 text-white font-semibold py-3">Konfirmasi</button>
      </div>
    </div>
  </dialog>

  <script src="app.js"></script>
  <script src="nav.js"></script>
  <script src="services.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js', { scope: './' }).catch(()=>{});
      });
    }
    function el(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild; }
    (async function(){
      await APP.load();
      applyBrand('brand');
      renderBottomNav('bottomnav');
      APP.injectSchema();

      const state = { service:null, serviceId:null, stylist:(APP.cfg.team||[])[0]||null, date:null, time:null };
      const summary = document.getElementById('summary');
      const btnBook = document.getElementById('btnBook');
      function updateSummary(){
        const s = state; const parts = [];
        if(s.service) parts.push(s.service);
        if(s.stylist) parts.push(`dengan ${s.stylist.name}`);
        if(s.date) parts.push(s.date.toLocaleDateString('id-ID', {weekday:'long', day:'2-digit', month:'short'}));
        if(s.time) parts.push(s.time);
        btnBook.disabled = !(s.service && s.stylist && s.date && s.time);
        summary.textContent = parts.length? parts.join(' • ') : 'Belum ada pilihan.';
      }

      function refreshSlots(){
        const s = state;
        if(!s.date){ s.date = new Date(); }
        const wrap = document.getElementById('slots');
        if(wrap){ wrap.innerHTML = '<div class="text-xs text-slate-500">Memuat slot…</div>'; }
        APP.getSlots({ date:s.date, stylistId:s.stylist?.id, serviceId:s.serviceId }).then(slots=>{
          if(!wrap) return;
          wrap.innerHTML = '';
          let added = 0;
          let selectedExists = false;
          slots.forEach(obj=>{
            const t = typeof obj==='string'? obj : obj.time;
            const available = typeof obj==='object'? (obj.available!==false) : true;
            const rawStatus = (obj && obj.status) ? String(obj.status).toLowerCase() : '';
            const booked = !available || rawStatus === 'booked';
            const pending = rawStatus === 'hold' || rawStatus === 'pending';

            let cls = 'rounded-2xl border px-4 py-3 text-sm ';
            if (booked){
              cls += 'bg-slate-100 border-slate-300 text-slate-500 opacity-70 cursor-not-allowed pointer-events-none line-through';
            } else if (pending){
              cls += 'bg-amber-50 border-amber-300 text-amber-800';
            } else {
              cls += 'bg-white border-pink-200 text-pink-700 hover:border-pink-400';
            }
            let badge = '';
            if (booked) badge = ' <span class="ml-2 text-[10px] uppercase tracking-wide bg-slate-200 text-slate-700 px-1.5 py-[1px] rounded">Booked</span>';
            else if (pending) badge = ' <span class="ml-2 text-[10px] uppercase tracking-wide bg-amber-100 text-amber-800 px-1.5 py-[1px] rounded">Hold</span>';

            const title = booked ? 'Slot sudah terisi' : (pending ? 'Slot dalam proses' : 'Pilih jam ini');
            const btn = el(`<button class="${cls}" ${booked?'disabled':''} title="${title}">${t}${badge}</button>`);
            if(!booked && !pending){
              btn.addEventListener('click', ()=>{
                state.time = t;
                ;[].forEach.call(wrap.children, c=>c.classList.remove('bg-pink-600','text-white','border-pink-600','font-semibold'));
                // normalize base classes so selected state is consistent
                btn.classList.remove('bg-white','border-pink-200','text-pink-700','hover:border-pink-400','bg-amber-50','border-amber-300','text-amber-800');
                btn.classList.add('bg-pink-600','text-white','border-pink-600','font-semibold');
                updateSummary();
              });
            }
            if (state.time === t && !booked && !pending){
              btn.classList.remove('bg-white','border-pink-200','text-pink-700','hover:border-pink-400','bg-amber-50','border-amber-300','text-amber-800');
              btn.classList.add('bg-pink-600','text-white','border-pink-600','font-semibold');
              selectedExists = true;
            }
            wrap.appendChild(btn);
            added++;
          });
          if (added === 0){
            wrap.appendChild(el('<div class="text-xs text-slate-500">Tidak ada slot tersedia.</div>'));
          }
          if (state.time && !selectedExists){
            state.time = null;
            updateSummary();
          }
        });
      }

      renderServicesWithPrices(APP.cfg.services||[], 'services', 'priceList', (svc)=>{ state.service=svc.name; state.serviceId=svc.id; updateSummary(); refreshSlots(); });

      const teamWrap = document.getElementById('team');
      (APP.cfg.team||[]).forEach((m,i)=>{
        const card = el(`
          <button class="snap-start min-w-[220px] card bg-white rounded-2xl text-left overflow-hidden">
            <div class="flex items-center gap-3 p-3">
              <img loading="lazy" class="h-12 w-12 rounded-full object-cover" src="${m.photo}" alt="${m.name}">
              <div class="flex-1">
                <p class="font-semibold text-sm leading-tight">${m.name}</p>
                <p class="text-xs text-slate-500">${m.role}</p>
                <p class="text-xs text-pink-600 font-medium mt-0.5">★ ${m.rating}</p>
              </div>
            </div>
          </button>
        `);
        card.addEventListener('click', ()=>{
          state.stylist = m;
          document.getElementById('profile-photo').src = m.photo;
          document.getElementById('profile-name').textContent = m.name;
          document.getElementById('profile-role').textContent = m.role || '';
          [...teamWrap.children].forEach(c=>c.classList.remove('ring-2','ring-pink-400'));
          card.classList.add('ring-2','ring-pink-400');
          updateSummary();
          refreshSlots();
        });
        if(i===0){
          card.classList.add('ring-2','ring-pink-400');
          document.getElementById('profile-photo').src = m.photo;
          document.getElementById('profile-name').textContent = m.name;
          document.getElementById('profile-role').textContent = m.role || '';
        }
        teamWrap.appendChild(card);
      });

      const weekWrap = document.getElementById('week');
      const now = new Date();
      const hari = ['Min','Sen','Sel','Rab','Kam','Jum','Sab'];
      for (let i=0;i<7;i++){
        const d = new Date(now); d.setDate(now.getDate()+i);
        const isToday = i===0;
        const node = el(`<button class="rounded-xl py-2 px-2 text-xs ${isToday?'bg-pink-600 text-white':'bg-white text-pink-700'} border border-transparent hover:border-pink-300"><div class="uppercase">${hari[d.getDay()]}</div><div class="font-bold">${d.getDate()}</div></button>`);
        node.addEventListener('click', ()=>{
          state.date = d;
          [...weekWrap.children].forEach(c=>c.classList.remove('ring-2','ring-pink-400'));
          node.classList.add('ring-2','ring-pink-400');
          updateSummary();
        });
        weekWrap.appendChild(node);
      }

      const slotsWrap = document.getElementById('slots');
      refreshSlots();

      

      const dlg = document.getElementById('dlg');
      document.getElementById('dlgClose').onclick = ()=> dlg.close();
      document.getElementById('dlgConfirm').onclick = async ()=>{
        dlg.close();
        const s = state;
        const customer = (document.getElementById('custName')?.value || '').trim();
        if(!customer){ alert('Mohon isi Nama Pemesan.'); return; }
        try{ localStorage.setItem('custName', customer);}catch(e){}
        const msg = `Halo, saya ingin booking:\n\n` +
          `Nama Pemesan: ${customer}\n` +
          `Layanan: ${s.service}\n` +
          `Stylist: ${s.stylist?.name || '-'}\n` +
          `Tanggal: ${s.date ? s.date.toLocaleDateString('id-ID',{weekday:'long', day:'2-digit', month:'long', year:'numeric'}) : '-'}\n` +
          `Jam: ${s.time || '-'}\n`;
        // Send to Google Apps Script if configured
        const payload = {
          customer,
          service: s.service,
          serviceId: s.serviceId,
          stylistId: s.stylist?.id || '',
          stylist: s.stylist?.name || '',
          date: APP._fmtYMD(s.date || new Date()),
          time: s.time,
          createdAt: new Date().toISOString()
        };
        try{ const resp = await APP.postBooking(payload); if(!resp.ok){ console.warn('Booking not saved to sheet'); } }catch(e){}
        // WhatsApp
        const url = `https://wa.me/${(APP.cfg&&APP.cfg.ownerWhatsApp)||'6281234567890'}?text=${encodeURIComponent(msg)}`;
        window.open(url, '_blank');
        // Refresh slots
        refreshSlots();
      };
      btnBook.onclick = ()=>{
        document.getElementById('cName').textContent = state.stylist?.name ?? '-';
        document.getElementById('cService').textContent = state.service ?? '-';
        document.getElementById('cDate').textContent = state.date ? state.date.toLocaleDateString('id-ID',{weekday:'long', day:'2-digit', month:'long', year:'numeric'}) : '-';
        document.getElementById('cTime').textContent = state.time ?? '-';
        try{ const saved = localStorage.getItem('custName'); if(saved) document.getElementById('custName').value = saved; }catch(e){}
        dlg.showModal();
      };

      state.date = new Date();
      if (weekWrap && weekWrap.children[0]) weekWrap.children[0].classList.add('ring-2','ring-pink-400');
      // initial slot selection will occur on user click; no preselect when dynamic
      // state.time left as null until user chooses
      updateSummary();
    })();
  </script>
</body>
</html>



